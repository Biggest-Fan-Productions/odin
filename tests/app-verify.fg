# Set up the database
odin.sql.file (module.path.join ../Schema/core/000-initial.blue.sql)
odin.sql.file (module.path.join ../Schema/authn/001-initial.blue.sql)
odin.sql.file (module.path.join ../Schema/app/002-initial.blue.sql)

# Set up new users and apps
odin.user owner password1234
odin.user player1 password1234
odin.user player2 password1234
odin.sql.file (module.path.join app-login-test-figure.sql)

# Support only POST
GET odin/app /verify/ 501
GET odin/app /verify/app01/ 501

# Validate Payload
POST odin/app /verify/ {} 501
POST odin/app /verify/app01/ {} 501
POST odin/app /verify/app01/ {"random_key": "player1"} 501
POST odin/app /verify/random_app/ {} 501
POST odin/app /verify/app01/ {"token": "player1"} 501

set user_jwt (odin.jwt.mint {"sub": "player1", "iss": "app01"} <JWT_SECRET>app01)
set payload {}
set-path payload ["token"] (lookup user_jwt)
POST odin/app /verify/app01/ (lookup payload) 200 {}

# Use wrong app
set user_jwt (odin.jwt.mint {"sub": "player1", "iss": "app02"} <JWT_SECRET>app02)
set payload {}
set-path payload ["token"] (lookup user_jwt)
POST odin/app /verify/app01/ (lookup payload) 501
