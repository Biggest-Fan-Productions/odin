# Set up the database
odin.sql.file (module.path.join ../Schema/core/000-initial.blue.sql)
odin.sql.file (module.path.join ../Schema/authn/001-initial.blue.sql)
odin.sql.file (module.path.join ../Schema/app/002-initial.blue.sql)
odin.sql.file (module.path.join ../Schema/app/003-app-role.blue.sql)

# Set up new users and apps
odin.user owner password1234
odin.user player1 password1234
odin.user player2 password1234
odin.user player3 password1234
odin.sql.file (module.path.join app-login-test-figure.sql)

GET test/app/secure / 401

# Mint App jwt
set app_jwt (odin.jwt.mint {"sub": "some_user", "iss": "app01"} APP_TOKEN)
set-path testserver.headers ["Authorization"] (cat "Bearer " (lookup app_jwt))
GET test/app/secure / 200
GET test/app/secure /test 200

# Wrong App jwt should return 401
set app_jwt (odin.jwt.mint {"sub": "some_user", "iss": "app02"} APP_TOKEN)
set-path testserver.headers ["Authorization"] (cat "Bearer " (lookup app_jwt))
GET test/app/secure / 401
GET test/app/secure /test 401

